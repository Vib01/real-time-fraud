// Add thresholds
const LOW_THRESHOLD = 0.3;
const MEDIUM_THRESHOLD = 0.5;
const HIGH_THRESHOLD = 0.7;
import { DynamoDBClient, PutItemCommand } from "@aws-sdk/client-dynamodb";


import { SNSClient, PublishCommand } from "@aws-sdk/client-sns";
 import { CloudWatchClient, PutMetricDataCommand } from "@aws-sdk/client-cloudwatch";
  // AWS clients
   const dynamodb = new DynamoDBClient({});
   const sns = new SNSClient({}); const cloudwatch = new CloudWatchClient({});
    // Env variables 
    const TABLE_NAME = process.env.TRANSACTION_TABLE || "FraudTransactions"; 
    const FRAUD_TOPIC = process.env.FRAUD_ALERT_TOPIC || "arn:aws:sns:us-east-2:915198917063:FraudAlerts";

export const handler = async (event) => {
  for (const record of event.Records) {
    try {
      const message = JSON.parse(record.body);
      const { transaction_id, amount } = message;

      console.log("Processing transaction:", message);

      // Fraud scoring
      let fraudScore = amount / 2000;       // base: amount / max
      fraudScore += Math.random() * 0.1;    // small randomness
      if (fraudScore > 1) fraudScore = 1;

      // Decision tiering
      let riskLabel;
      if (fraudScore < LOW_THRESHOLD) riskLabel = "LOW";
      else if (fraudScore < MEDIUM_THRESHOLD) riskLabel = "MEDIUM";
      else if (fraudScore < HIGH_THRESHOLD) riskLabel = "HIGH";
      else riskLabel = "CRITICAL";

      const isFraud = fraudScore > 0.7;

      console.log(`Fraud Score: ${fraudScore.toFixed(2)}, Risk Level: ${riskLabel}, Fraud detected: ${isFraud}`);

      // Store in DynamoDB
      await dynamodb.send(new PutItemCommand({
        TableName: TABLE_NAME,
        Item: {
          transaction_id: { S: transaction_id },
          amount: { N: amount.toString() },
          fraud_score: { N: fraudScore.toString() },
          risk_label: { S: riskLabel },           // new field
          is_fraud: { BOOL: isFraud },
          timestamp: { S: new Date().toISOString() }
        }
      }));

      // Actions per tier
      if (["HIGH", "CRITICAL"].includes(riskLabel)) {
        await sns.send(new PublishCommand({
          TopicArn: FRAUD_TOPIC,
          Message: `ðŸš¨ ${riskLabel} Risk! Transaction ${transaction_id} flagged with score ${fraudScore.toFixed(2)}`
        }));
      }

      // CloudWatch metrics
      await cloudwatch.send(new PutMetricDataCommand({
        Namespace: "FraudDetection",
        MetricData: [
          { MetricName: "TotalTransactions", Value: 1, Unit: "Count" },
          { MetricName: "FraudulentTransactions", Value: isFraud ? 1 : 0, Unit: "Count" },
          { MetricName: `Transactions_${riskLabel}`, Value: 1, Unit: "Count" } // tiered metric
        ]
      }));

    } catch (err) {
      console.error("Error processing message:", err.message, "Raw message:", record.body);
    }
  }

  return { statusCode: 200, body: "Processed all records" };
};
